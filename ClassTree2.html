<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>classtree2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ClassTree2_files/libs/clipboard/clipboard.min.js"></script>
<script src="ClassTree2_files/libs/quarto-html/quarto.js"></script>
<script src="ClassTree2_files/libs/quarto-html/popper.min.js"></script>
<script src="ClassTree2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ClassTree2_files/libs/quarto-html/anchor.min.js"></script>
<link href="ClassTree2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ClassTree2_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ClassTree2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ClassTree2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ClassTree2_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<section id="classification-trees---part-2" class="level2">
<h2 class="anchored" data-anchor-id="classification-trees---part-2">Classification Trees - Part 2</h2>
<section id="model-validation" class="level3">
<h3 class="anchored" data-anchor-id="model-validation">Model Validation</h3>
<p>How do we know if a predictive model that we build is actually any good?</p>
</section>
<section id="model-may-not-match-real-world.-it-good-when-it-works-well-when-we-use-it.-we-have-to-wait-for-new-data-but-need-to-know-ahead-of-time-the-results." class="level3">
<h3 class="anchored" data-anchor-id="model-may-not-match-real-world.-it-good-when-it-works-well-when-we-use-it.-we-have-to-wait-for-new-data-but-need-to-know-ahead-of-time-the-results.">Model may not match real world. It good when it works well when we use it. We have to wait for new data but need to know ahead of time the results.</h3>
<p>What if we could “simulate” the existence of new/unseen data in order to test our model? We can do this by splitting the data into two sets: a <strong>training set</strong> and a <strong>testing set</strong>.</p>
<p><img src="train_test.png" class="img-fluid" width="509"></p>
<p>The training set is used to develop the model, allowing it to learn and adapt to the patterns in the data. This is where the model tries to understand the relationships between input features and the target variable.</p>
<p>The testing set acts as a new, unseen data set for the model. It’s used to evaluate the model’s performance and generalization capabilities. By applying the model to the testing set, we can measure how well it has learned and how it performs on data it hasn’t encountered before. This separation into training and testing sets helps in <strong>preventing overfitting</strong>, ensuring that the model is robust and performs well on new, unseen data.</p>
<p>RULE OF THUMB: We put 70-80% of our data in the training set and the remainder in the testing set. If we have a very large dataset it may be OK to put less data in the testing set (i.e., 10% or so).</p>
<p>BIG NOTE: Only build models on the training set!!! Never on the testing set!!!</p>
<section id="workflow-only-build-models-on-the-training-set" class="level4">
<h4 class="anchored" data-anchor-id="workflow-only-build-models-on-the-training-set">Workflow (ONLY BUILD MODELS ON THE TRAINING SET)</h4>
<p><strong>Load Data</strong> –&gt; Clean/Prepare –&gt; <strong>Split</strong> –&gt; Visualize (on Training Data) –&gt; <strong>Build Models</strong> (on Training Data) –&gt; Select Best Model(s) –&gt; <strong>Evaluate on Testing Set</strong></p>
</section>
<section id="data-loading-cleaning-and-preparation" class="level4">
<h4 class="anchored" data-anchor-id="data-loading-cleaning-and-preparation">Data Loading, Cleaning, and Preparation</h4>
<p>Load the dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>titanic <span class="ot">=</span> titanic<span class="sc">::</span>titanic_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Clean and prep work (as usual)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># factor conversion and recoding</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>titanic <span class="ot">=</span> titanic <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Survived =</span> <span class="fu">as_factor</span>(Survived)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Survived =</span> <span class="fu">fct_recode</span>(Survived, <span class="st">"No"</span> <span class="ot">=</span> <span class="st">"0"</span>, <span class="st">"Yes"</span> <span class="ot">=</span> <span class="st">"1"</span> )) <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Pclass =</span> <span class="fu">as_factor</span>(Pclass)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">as_factor</span>(Sex)) <span class="sc">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>PassengerId, <span class="sc">-</span>Name, <span class="sc">-</span>Ticket, <span class="sc">-</span>Fare, <span class="sc">-</span>Cabin, <span class="sc">-</span>Embarked)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># imputation</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>) <span class="co">#sets seed for random number generator</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>imp_age <span class="ot">=</span> <span class="fu">mice</span>(titanic, <span class="at">m=</span><span class="dv">5</span>, <span class="at">method=</span><span class="st">'pmm'</span>, <span class="at">printFlag=</span><span class="cn">FALSE</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#m is the number of imputations, 5 is a reasonable value as a default</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#pmm is "predictive mean matching" = imputation method for numeric data</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#printFlag reduces amount of output</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>titanic_complete <span class="ot">=</span> <span class="fu">complete</span>(imp_age) </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># view the cleaned and prepared data</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(titanic_complete)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Survived  Pclass      Sex           Age            SibSp      
 No :549   1:216   male  :577   Min.   : 0.42   Min.   :0.000  
 Yes:342   2:184   female:314   1st Qu.:19.00   1st Qu.:0.000  
           3:491                Median :28.00   Median :0.000  
                                Mean   :29.32   Mean   :0.523  
                                3rd Qu.:39.00   3rd Qu.:1.000  
                                Max.   :80.00   Max.   :8.000  
     Parch       
 Min.   :0.0000  
 1st Qu.:0.0000  
 Median :0.0000  
 Mean   :0.3816  
 3rd Qu.:0.0000  
 Max.   :6.0000  </code></pre>
</div>
</div>
</section>
<section id="model-validation-1" class="level4">
<h4 class="anchored" data-anchor-id="model-validation-1">Model Validation</h4>
<p>starts the random number generator at the same point</p>
<p>STRATA IS OUR RESPONCE VARIABLE</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co">#ensures we all get the same splits/starts the random number generator at the same point</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>titanic_split <span class="ot">=</span> <span class="fu">initial_split</span>(titanic_complete, <span class="at">prop =</span> <span class="fl">0.7</span>, <span class="at">strata =</span> Survived) <span class="co">#70% in training</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#STRATA IS OUR RESPONCE VARIABLE</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> <span class="fu">training</span>(titanic_split) </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> <span class="fu">testing</span>(titanic_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="building-classification-trees" class="level4">
<h4 class="anchored" data-anchor-id="building-classification-trees">Building Classification Trees</h4>
<p>Build our classification tree from before (all variables as potential predictors) on the TRAINING set.</p>
<p>~ . is running against all the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>tree_model1 <span class="ot">=</span> <span class="fu">rpart</span>(Survived <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"class"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fancyRpartPlot</span>(tree_model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ClassTree2_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="classification-tree-performance" class="level4">
<h4 class="anchored" data-anchor-id="classification-tree-performance">Classification Tree Performance</h4>
<p>We evaluate model performance on the training set first. Be sure that you have the correct data frame name in your predict and confusionMatrix functions! Also, pay attention to the value for “positive”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>treepred_train <span class="ot">=</span> <span class="fu">predict</span>(tree_model1, train, <span class="at">type =</span> <span class="st">"class"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(treepred_train,train<span class="sc">$</span>Survived,<span class="at">positive=</span><span class="st">"Yes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  No Yes
       No  342  55
       Yes  42 184
                                          
               Accuracy : 0.8443          
                 95% CI : (0.8134, 0.8719)
    No Information Rate : 0.6164          
    P-Value [Acc &gt; NIR] : &lt;2e-16          
                                          
                  Kappa : 0.6674          
                                          
 Mcnemar's Test P-Value : 0.2231          
                                          
            Sensitivity : 0.7699          
            Specificity : 0.8906          
         Pos Pred Value : 0.8142          
         Neg Pred Value : 0.8615          
             Prevalence : 0.3836          
         Detection Rate : 0.2953          
   Detection Prevalence : 0.3628          
      Balanced Accuracy : 0.8302          
                                          
       'Positive' Class : Yes             
                                          </code></pre>
</div>
</div>
<p>No Information Rate : 0.6164 is a benchmark, this would classify the majority</p>
<p>If we are happy with model performance on the training set, we can then consider this to be our “best” model and move on to evaluate performance on the testing set. As before, be very careful to use the correct data frame names in your code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>treepred_test <span class="ot">=</span> <span class="fu">predict</span>(tree_model1, test, <span class="at">type =</span> <span class="st">"class"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(treepred_test,test<span class="sc">$</span>Survived,<span class="at">positive=</span><span class="st">"Yes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  No Yes
       No  137  27
       Yes  28  76
                                          
               Accuracy : 0.7948          
                 95% CI : (0.7414, 0.8415)
    No Information Rate : 0.6157          
    P-Value [Acc &gt; NIR] : 2.35e-10        
                                          
                  Kappa : 0.5671          
                                          
 Mcnemar's Test P-Value : 1               
                                          
            Sensitivity : 0.7379          
            Specificity : 0.8303          
         Pos Pred Value : 0.7308          
         Neg Pred Value : 0.8354          
             Prevalence : 0.3843          
         Detection Rate : 0.2836          
   Detection Prevalence : 0.3881          
      Balanced Accuracy : 0.7841          
                                          
       'Positive' Class : Yes             
                                          </code></pre>
</div>
</div>
<p>On the training set we experienced an accuracy of: <strong>84.43%</strong>. This dropped to <strong>79.48%</strong> on the testing set. This is VERY typical. Is this drop-off in accuracy too much?</p>
<hr>
<p>For comparison, let’s look at our logistic regression model and see how the performance of that model stacks up to our tree.</p>
<p>We’ll build our logistic regression model on the training set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>log_model1 <span class="ot">=</span> <span class="fu">glm</span>(Survived <span class="sc">~</span>., train, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(log_model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Survived ~ ., family = "binomial", data = train)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  1.45354    0.40205   3.615 0.000300 ***
Pclass2     -1.11312    0.32491  -3.426 0.000613 ***
Pclass3     -2.42100    0.30614  -7.908 2.61e-15 ***
Sexfemale    2.88982    0.24656  11.720  &lt; 2e-16 ***
Age         -0.04423    0.00826  -5.355 8.54e-08 ***
SibSp       -0.45563    0.14986  -3.040 0.002362 ** 
Parch       -0.09192    0.13636  -0.674 0.500248    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 829.60  on 622  degrees of freedom
Residual deviance: 532.49  on 616  degrees of freedom
AIC: 546.49

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Remove Parch because it’s not significant (notice the use of -Parch to remove this variable from the list of all variables):</p>
</section>
</section>
</section>
<section id="parch-removes-parch-from-the-data" class="level2">
<h2 class="anchored" data-anchor-id="parch-removes-parch-from-the-data">~.-Parch (removes Parch from the data)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>log_model2 <span class="ot">=</span> <span class="fu">glm</span>(Survived <span class="sc">~</span>.<span class="sc">-</span>Parch, train, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(log_model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Survived ~ . - Parch, family = "binomial", data = train)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  1.444643   0.401886   3.595 0.000325 ***
Pclass2     -1.118692   0.324550  -3.447 0.000567 ***
Pclass3     -2.427684   0.305892  -7.936 2.08e-15 ***
Sexfemale    2.856250   0.240731  11.865  &lt; 2e-16 ***
Age         -0.044191   0.008258  -5.351 8.72e-08 ***
SibSp       -0.486291   0.143889  -3.380 0.000726 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 829.60  on 622  degrees of freedom
Residual deviance: 532.95  on 617  degrees of freedom
AIC: 544.95

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
</section>
<section id="probabilities" class="level2">
<h2 class="anchored" data-anchor-id="probabilities"><strong>Probabilities</strong></h2>
<p>Develop predictions on the training set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>logpred_train <span class="ot">=</span> <span class="fu">predict</span>(log_model2, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are <strong>probabilities</strong> that we now need to convert to classes (using a probability threshold). We have code (from a previous lecture) to help us find the threshold that this best to maximize accuracy (as before, be careful with names of objects):</p>
<p>(ROC Curve)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">prediction</span>(logpred_train, train<span class="sc">$</span>Survived)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>perf <span class="ot">=</span> <span class="fu">performance</span>(pred,<span class="st">"tpr"</span>,<span class="st">"fpr"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(perf, <span class="at">colorize=</span><span class="cn">TRUE</span>, <span class="at">print.cutoffs.at=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.1</span>), <span class="at">text.adj=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.2</span>,<span class="fl">1.7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ClassTree2_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot accuracy as function of threshold</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>acc.perf <span class="ot">=</span> <span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"acc"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(acc.perf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ClassTree2_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># find best threshold to maximize accuracy</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">=</span> <span class="fu">which.max</span>( <span class="fu">slot</span>(acc.perf, <span class="st">"y.values"</span>)[[<span class="dv">1</span>]] )</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>acc <span class="ot">=</span> <span class="fu">slot</span>(acc.perf, <span class="st">"y.values"</span>)[[<span class="dv">1</span>]][ind]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>cutoff <span class="ot">=</span> <span class="fu">slot</span>(acc.perf, <span class="st">"x.values"</span>)[[<span class="dv">1</span>]][ind]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="at">accuracy=</span> acc, <span class="at">cutoff =</span> cutoff))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  accuracy cutoff.572 
 0.8330658  0.5625394 </code></pre>
</div>
</div>
<p>We get a best cutoff (threshold) of: <strong>0.5625394</strong> to maximize accuracy! We’ll use this threshold on the training AND testing sets! Do not build models OR make new thresholds using the testing set data!!</p>
</section>
<section id="confusion-matrix" class="level2">
<h2 class="anchored" data-anchor-id="confusion-matrix">Confusion Matrix</h2>
<p>Let’s check out (manually, unfortunately for logistic regression) our accuracy on the training set.</p>
<p><strong>(Training will display a “perfect” cutoff = 0.5625394 and this becomes our threshold)</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">=</span> <span class="fu">table</span>(logpred_train <span class="sc">&gt;</span> <span class="fl">0.5625394</span>, train<span class="sc">$</span>Survived)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>table1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       
         No Yes
  FALSE 353  73
  TRUE   31 166</code></pre>
</div>
</div>
</section>
<section id="accuracy-is-then" class="level2">
<h2 class="anchored" data-anchor-id="accuracy-is-then">Accuracy is then:</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(table1[<span class="dv">1</span>,<span class="dv">1</span>] <span class="sc">+</span> table1[<span class="dv">2</span>,<span class="dv">2</span>])<span class="sc">/</span><span class="fu">nrow</span>(train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8330658</code></pre>
</div>
</div>
<p>Our logistic regression model has an accuracy of <strong>83.31%</strong> on the training set (this is competitive with the accuracy of our classification tree). Let’s see what happens when we check out the accuracy on the testing set. Start by making predictions on the testing set and then develop a confusion matrix (using the same threshold!). DO NOT DEVELOP A NEW MODEL OR THRESHOLD USING THE TESTING DATA!! Be careful to add the “newdata” argument to the predict function!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>logpred_test <span class="ot">=</span> <span class="fu">predict</span>(log_model2, <span class="at">newdata=</span>test, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>table2 <span class="ot">=</span> <span class="fu">table</span>(logpred_test <span class="sc">&gt;</span> <span class="fl">0.5625394</span>, test<span class="sc">$</span>Survived)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>table2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       
         No Yes
  FALSE 146  35
  TRUE   19  68</code></pre>
</div>
</div>
<p>Accuracy on the testing set is then:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>(table2[<span class="dv">1</span>,<span class="dv">1</span>] <span class="sc">+</span> table2[<span class="dv">2</span>,<span class="dv">2</span>])<span class="sc">/</span><span class="fu">nrow</span>(test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7985075</code></pre>
</div>
</div>
<p>Accuracy drops to <strong>79.85%</strong>. This is expected and typical.</p>
<hr>
<p>Let’s make a “pretty” table of our results. We’ll do this manually. First make a little data frame (actually a “tidyverse” tibble) to hold our content for the table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Logistic Regression"</span>, <span class="st">"Classification Tree"</span>, <span class="st">"Naive"</span>),</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">Training Accuracy</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"83.31%"</span>,<span class="st">"84.43%"</span>,<span class="st">"61.64%"</span>),</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">Testing Accuracy</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"79.85%"</span>,<span class="st">"79.48%"</span>,<span class="st">"61.57%"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Insert the data frame into a table via the “formattable” package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">formattable</span>(results, <span class="at">align =</span><span class="fu">c</span>(<span class="st">"c"</span>,<span class="st">"c"</span>,<span class="st">"c"</span>,<span class="st">"c"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table table-condensed">
<thead>
<tr>
<th style="text-align:center;">
Model
</th>
<th style="text-align:center;">
Training Accuracy
</th>
<th style="text-align:center;">
Testing Accuracy
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
Logistic Regression
</td>
<td style="text-align:center;">
83.31%
</td>
<td style="text-align:center;">
79.85%
</td>
</tr>
<tr>
<td style="text-align:center;">
Classification Tree
</td>
<td style="text-align:center;">
84.43%
</td>
<td style="text-align:center;">
79.48%
</td>
</tr>
<tr>
<td style="text-align:center;">
Naive
</td>
<td style="text-align:center;">
61.64%
</td>
<td style="text-align:center;">
61.57%
</td>
</tr>
</tbody>

</table>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>